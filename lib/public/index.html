<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="UTF-8">
    <title>API Proxy Starter</title>
</head>

<style>

  table, th, td {
    border: 1px solid black;
  }

</style>

<body>

<div id="yelp">
  <h2>Yelp</h2>
  <form>
    <label for="yelp-input">Search for a </label>
    <input id="yelp-term" type="text" placeholder="e.g. cafe, bar, restaurant, etc.">
    <label for ="yelp-loc">near </label>
    <input id="yelp-loc" type="text" placeholder="Address or city">
    <label for="radius">within a radius of </label>
    <select name="radius" id="radius-input">
      <option value="2">2 miles</option>
      <option value="5">5 miles</option>
      <option value="10">10 miles</option>
    </select>
    <input id="yelp-btn" type="submit" value="Search">
  </form>
  <div>
    <table id="yelp-results">
      <tr>
        <th>Name</th>
        <th>Address</th>
        <th>For more information</th>
      </tr>
    </table>
  </div>
</div>

<div id="geocode">
  <h2>Geocode</h2>
  <form>
    <input id="geocode-input" type="text" placeholder="Address">
    <input id="geocode-btn" type="submit" value="Get Coordinates">
  </form>
  <table id="geocode-results">
    <tr>
      <th>Address</th>
      <th>Coordinates</th>
    </tr>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>

<!-- YELP -->
<script>

  $("#yelp-btn").on("click", function(e) {

    e.preventDefault();

    function getMeters(i) {
      return i*1609.344;
    }

    var yelpURL = "/api/yelp/v3/businesses/search";
    var term = $("#yelp-term").val();
    var location = $("#yelp-loc").val();
    var radiusMiles = $("#radius-input option:selected").attr("value");
    var radiusMeters = getMeters(radiusMiles);
    // Yelp takes radius in meters

    yelpURL += "?" + $.param({
        "term": term,
        "location": location,
        "limit": 10,
        "distance": radiusMeters //not sure if this works properly; check again later
      });
    // GLOBAL var for access token
    var accessToken = "dansSf9_Muex3BxxaCcbl3S2Up3UnypA";

    // do this one time
    $.ajax({
      url: "/api/yelp/oauth2/token",
      method: "POST",
      data: {
        grant_type: "client_credentials",
        client_id: "DKj-IPb7Z7qjDMphovCP9g",
        client_secret: "nL0yFJUv5cA95FmDE6Fq5B1jo4ss6z2dGpvvK5XFM9T6ii0ehmP6dypGBzA4rxuj"
      }
    }).done(function (response) {
      console.log(response);

      // update global variable for your accessToken
      accessToken = response.access_token;

      $.ajax({
        // '/api/yelp/' + everything in the examples after 'https://api.yelp.com/' i.e.
        url: yelpURL,
        method: "GET",
        headers: {
          // use your access token in every API request to proxy
          Authorization: "Bearer " + accessToken
        }
      }).done(function (response) {
        for (i = 0; i < response.businesses.length; i++) {
          var businessName = response.businesses[i].name;
          var businessAddress = response.businesses[i].location.display_address[0] + ", " + response.businesses[i].location.display_address[1];
          var yelpLink = response.businesses[i].url;

          $("#yelp-results").append("<tr><td>" + businessName + "</td></td><td>" + businessAddress + "</td><td><a href='" + yelpLink + "' target='_blank'>Go to Yelp Page</a></td></tr>");
        }
      });
    }).fail(function (err) {
      console.error(err)
    });
  });

</script>

<!-- GEOCODE -->
<script>

  $("#geocode-btn").on("click", function(event) {

    event.preventDefault();

    var geocodeURL = "/api/geocode";
    var address = $("#geocode-input").val();
    var geocodeKey = "AIzaSyBDX_eXekJVgS9WjggIhZRQbvNXlbFQDsc";

    geocodeURL += "?" + $.param({
        "api_key": geocodeKey,
        "address": address
      });

    $.ajax({
      // '/api/flightstats/' + everything in the examples after '/v2/json/' i.e.
      url: geocodeURL,
      method: "GET"
    }).done(function (response) {
      console.log(response);
      var formattedAddress = response.results[0].formatted_address;
      var lat = response.results[0].geometry.location.lat;
      var lng = response.results[0].geometry.location.lng;
      var coordinates = "(" + lat + ", " + lng + ")";

      $("#geocode-results").append("<tr><td>" + formattedAddress + "</td><td>" + coordinates + "</td></tr>");

    }).fail(function (err) {
      console.error(err)
    });

    $("#geocode-input").val("");
  });

</script>

</body>

</html>
